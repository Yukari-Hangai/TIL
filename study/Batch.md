# バッチ処理
## 「バッチ」とは
複数のプログラムの連続的な連なりによって導き出される結果をひとまとめにしたものがバッチ（Batch）です。
以下は例です。

* プログラムA：データの抽出
* プログラムB：データの加工
* プログラムC：加工データの出力（保存）

プログラムA〜Cによるプログラム群をまとめたものをバッチと言います。
よく定時処理をバッチ処理と表現することがありますが、バッチ処理は定時処理ということではありません。
バッチ処理はプログラムをまとめたものです。
しかし、バッチ処理は定時処理を行うことがほとんどです。

## なぜバッチ処理が必要なのか
毎日のルーチンワークの中で人の手によって行われるものをバッチ処理としておくことで、コンピューターリソースを使い作業効率を向上することができます。
「即時性のない処理」で大量のデータを扱うものではバッチ処理の導入が適切になります。

### 処理の即時性
例えばコンビニのスタッフとしてシステムを利用することを思い浮かべてみましょう。
お客さんが商品を購入した時に店側はレシートを発行しなければなりません。
この場合は商品の購入という処理に対してレシートの発行という処理は「即時性がある処理」と言えます。

一方で、コンビニの1日の売上を集計するといった時はお客さんが商品を購入するたびに、その日の売上を立てる必要はありません。
店舗として当日10:00から翌日の10:00までを1日の売上とする場合には翌日の10:00になった時に1日の売上を集計して報告します。
この場合は商品の購入という処理に対して1日の売上集計は「即時性のない処理」と言えます。

1日のコンビニの利用者は10人や20人といったものではありません。
1日に約1000人が利用するというデータもあります。
毎日、1日の売上集計をする時に1000人分の売上のデータを計算することは「即時性がなく、大量のデータを扱う」ことですのでバッチ処理を導入することが適切だと言えます。

## バッチ処理の実装例
#### 銀行のバッチ処理
銀行では日中、入出金や記帳などあらゆる取引が行われています。
時間外取引においては大量のデータを蓄え、フォーマットを整えて時間になったら送金するといったバッチ処理が存在します。

#### 業務管理システムのバッチ処理
一言に業務管理システムと言っても業種により扱うデータや運用の流れが違います。
ですが業種を問わず共通する事もあります。

* 月間売上（売上、発注料、経費、利益率、粗利）
* 在庫管理

上に挙げたものは業種を問わずに多くの業務管理システムで扱う項目です。
ひとつ、月間売上を例とするならば締日に日毎の売上データから算出して月間売上データを作成するといったバッチ処理があります。
また、業務システムにおいて最もポピュラーなものです。

## バッチ処理の実装
今回作成するバッチ処理では、アプリケーションを完成させよう 8章【課題：アプリケーションを作成してみよう：基礎編】で作成したBookersを使用します。
Bookersでは本のタイトルと本文を入力して投稿することができました。
今回は投稿したデータを2分おきに全て削除するバッチ処理を実装します。

### 削除プログラムを作成
libの配下にbatchフォルダを作成します。
次に作成したbatchフォルダの中でdata_reset.rbファイルを作成して以下を記述して保存します。

~~~ruby
class Batch::DataReset
  def self.data_reset
    # 投稿を全て削除
    Book.delete_all
    p "投稿を全て削除しました"
  end
end
~~~

次に作成したlib/batch/data_reset.rbが読み込まれるように設定します。

config/application.rbに以下を追記してください。
~~~ruby
class Application < Rails::Application
  :
  :  
  config.paths.add 'lib', eager_load: true
end
~~~
このように記述することで、lib配下のファイルが読み込まれるようになります。

### 削除プログラムが実行されるか確認する
投稿データの削除を確認するために、いくつか投稿してデータを作っておきます。
Cloud9上でアプリケーションフォルダに移動して下記のコマンドを実行してみましょう。
~~~ruby
username:~/environment/bookers $ bundle exec rails runner Batch::DataReset.data_reset
~~~
以下のように出力されるはずです。
~~~ruby
Running via Spring preloader in process [プロセスID]
"投稿を全て削除しました"
~~~
次はcronを利用して削除プログラムを定時処理として実行させます。

### coronとは
cron（クーロン）とは定期的に指定のプログラムを実行するためのスケジューラーであり、UNIX系OSに標準搭載されている常駐プログラム（デーモン）です。
MacOSやLinux系OSもUNIX系OSに分類されるものです。
カリキュラムで使用されるCloud9で構築した環境はAmazonLinuxであり、CentOSをベースとするLinux系OSのひとつです。

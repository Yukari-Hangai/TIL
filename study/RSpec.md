# RSpecの記述
RSpec　＝　Webアプリケーションのテストのフレームワーク
## Webアプリケーションのテストとは
### 単体テスト
単体テストとはクラスやメソッド（関数）といった単位でのテストになります。
* 空白チェック
* 文字列チェック
* 数値チェック　　　　etc...
### 結合テスト
単体テストがクラスやメソッド（関数）といった単位でのテストに比べて、結合テストでは単体テストの組み合わせで期待とする動作が行えているかをテストします。

一つ例として挙げると、「フォームに値を入力して、送信ボタンを押すと値が保存される」といったものです。
### テストを行う理由
テストを行う理由には単にバグを見つけやすくするというだけではなく、機能要件に沿って開発ができているかという指針にもなります。
要件を満たしているという保証性やリリース後の品質リスクを考える上でも大変重要なことです。
テストを行わずにアプリケーションをリリースするといったことは、まず、ありえません。

現場によっては機能要件からテストを先に記述して、テスト要件を満たすように実装とリファクタリングをするテスト駆動開発（TDD = Test Driven Development）といった開発手法もあります。

※リファクタリング　＝　ソフトウェアの外部的振る舞いを保ちつつ、理解や修正が簡単になるように、内部構造を改善すること
## RSpecとは何か
RSpecとは、Railsで用いられることが多いテストツールであり、Gemでinstallすることが可能なため、導入も簡単です。
Railsにはデフォルトでテストの機能が備わっています。
コードが読みやすく、ドキュメントも豊富です。
また、Railsで開発を行う現場でもRSpecを使用していることが多いです。
## RSpecの構成
まず、RSpecを使用する上で、コードの中で使用されるものを大まかに確認します。

* describe（テストの大きなくくりを示します：必須）
* context（describeより詳細に分ける場合にのみ使用します）
* it（具体的なテストの内容を示します：必須）
* before（itの内容を実行する前に必要であれば使用します）

構成の例としては図を参考にしてください。
![RSpec](https://wals.s3.amazonaws.com/uploads/363/363_rspec.png)

上の図をRSpecのコードに直すと以下のようになります。
~~~ruby
describe '四則演算' do
  context '足し算' do
    it '1 + 1 は 2 になる' do
      expect(1 + 1).to eq 2
    end
  end
  context '足し算' do
    it '3 + 2 は 5 になる' do
      expect(3 + 2).to eq 5
    end
  end
  context '引き算' do
    it '3 - 1 は 2 になる' do
      expect(3 - 1).to eq 2
    end
  end
  context '引き算' do
    it '5 - 2 は 3 になる' do
      expect(5 - 2).to eq 3
    end
  end
end
~~~
* describe
describeは、どのようなテストを行うかを大きなくくりで示したものです。 今回は四則演算のテストを行うので、このdescribeの中にそれに関連するテストを記述していきます。
~~~ruby
describe '四則演算' do

end
~~~

* context
contextは、describeの中をさらに分けたいときに記述しますが、必須ではありません。
四則演算の中にも足し算、引き算、掛け算、割り算がありますのでそのような場合に使用します。
~~~ruby
describe '四則演算' do

  context '足し算' do

  end

  context '引き算' do

  end

end
~~~

* it
itはどのようなテストを行うのか、具体的な内容を記述します。
今回は足し算、引き算のテストを行う場合の例です。
~~~ruby
describe '四則演算' do
  context '足し算' do
    it '1 + 1 は 2 になる' do
    end
    it '3 + 2 は 5 になる' do
    end
  end
  context '引き算' do
    it '3 - 1 は 2 になる' do
    end
    it '5 - 2 は 3 になる' do
    end
  end
end
~~~

* エクスペクテーションとマッチャー
~~~ruby
describe '四則演算' do
  context '足し算' do
    it '1 + 1 は 2 になる' do
      expect(1 + 1).to eq 2
    end
  end
  context '足し算' do
    it '1 + 1 は 2 になる' do
      expect(1 + 1).to eq 3
    end
  end
end
~~~
**expect().toの部分は「()内の値が期待値となるように」という意味があり、エクスペクテーションと呼ばれます。
eqはeqに続く値が期待値と同値であるかを判定しています。またeqの部分はマッチャーと呼ばれます。**
マッチャーはeqではなく様々な種類が存在しています。
RSpecでは基本的にエクスペクテーションと様々なマッチャーの組み合わせでテストを行っていきます。

* フック
上記のサンプルコードにはありませんがRSpecには「フック」というものが存在します。
よく使用されるフックに「before」があります。

beforeは以下のようにitの処理をする前に行う処理を記述します。
~~~ruby
context 'バリデーションによって正しいデータ以外保存しない' do
  before do
    '例：タイトルが入力されていないデータの作成'
  end
  it 'タイトルが入力されていない時は保存しない' do
  end
end
~~~
主に複数のitに対して前提となる共通処理などに利用されます。

以下はよく使われるマッチャーをまとめた表です。

|マッチャー名|機能|
|:--:|:--:|
|be_valid|有効であるか|
|be_invalid|無効であるか|
|include|配列に指定の値が含まれているか|
|find|要素の検索を行う|
|click|クリックを行う|
|have_content|文字列が存在するか|
|have_link|指定の値のリンクが存在するか|
|eq|期待値と値を比較して一致するか|
|have_selector|HTMLタグやCSSに指定の文字列が存在するか|
|have_field|入力フォームが存在するか|
|find_all|ページ上の指定のHTMLタグを全て取得する|
|match|matchメソッドを使用して期待値と一致するか|
|have_button|ページ上に指定のボタンが存在するか|
|click_button|指定のボタンをクリックする|
|have_current_path|パスを取得できる|

各種マッチャーにはオプションも存在していて、オプションを組み合わせることでテストの内容も変わってきます。
例えばhave_fieldを例に挙げてみます。
~~~ruby
expect(page).to have_field 'book[title]'
~~~
この場合にはname属性がbook[title]である入力フォームが存在するかを判定します。

~~~ruby
expect(page).to have_field 'book[title]', with: '初投稿'
~~~
この場合にはname属性がbook[title]、value値が「初投稿」という入力フォームが存在するかを判定します。

このようにマッチャーに対してオプションを付与することで、テストする項目のターゲットをより細かく指定したりするなど、多様です。
